apiVersion: v1
kind: PersistentVolume
metadata:
  name: sync-pv
spec:
  capacity:
    storage: 10Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Delete
  storageClassName: ""           # static PV
  awsElasticBlockStore:
    volumeID: VOLUME_ID_PLACEHOLDER
    fsType: ext4
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: sync-pvc
  namespace: sync
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  volumeName: sync-pv
  storageClassName: ""           # must match PV
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sync-config
  namespace: sync
data:
  SYNC_BUCKET: "mongodb-sync-bucket"
  ANONYMIZE_FIELDS: "email,phone,name,ssn"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: sync-sa
  namespace: sync
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::561030001202:role/mongodb-sync-role"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: sync-job
  namespace: sync
spec:
  backoffLimit: 0
  template:
    spec:
      serviceAccountName: sync-sa
      restartPolicy: Never
      nodeSelector:
        role: sync
        workload: data-sync
      containers:
      - name: mongo-sync
        image: 561030001202.dkr.ecr.us-east-1.amazonaws.com/mongo-sync:latest
        command: ["/bin/bash"]
        args:
        - -c
        - |
          echo "üîÑ Starting MongoDB anonymization from snapshot volume..."
          
          echo "‚è≥ Starting mongod from snapshot..."
          mongod --dbpath /data/db --bind_ip_all --fork --logpath /var/log/mongod.log
          sleep 5

          # Wait for MongoDB to be ready
          until mongosh "mongodb://127.0.0.1:27017/admin" --eval "db.adminCommand('ping')" > /dev/null 2>&1; do
            echo "‚è≥ Waiting for MongoDB from snapshot..."
            sleep 5
          done
          echo "‚úÖ MongoDB from snapshot is ready"

          # Get config
          SYNC_BUCKET=$$(cat /etc/config/SYNC_BUCKET)
          ANONYMIZE_FIELDS=$$(cat /etc/config/ANONYMIZE_FIELDS)
          DATETIME=$$(date +%Y%m%d-%H%M%S)

          echo "üì§ Dumping anonymized data to s3://${SYNC_BUCKET}/${DATETIME}/"

          # COUNT DOCUMENTS BEFORE ANONYMIZATION (PROD REFERENCE)
          USERS_COUNT=$$(mongosh "mongodb://127.0.0.1:27017/testdb" --quiet --eval "db.users.countDocuments()" | grep -o '[0-9]\+')
          POSTS_COUNT=$$(mongosh "mongodb://127.0.0.1:27017/testdb" --quiet --eval "db.posts.countDocuments()" | grep -o '[0-9]\+')
          echo "DOC_COUNT_users=$$USERS_COUNT"
          echo "DOC_COUNT_posts=$$POSTS_COUNT"
          
          # Process each collection
          for coll in users posts; do
            echo "üîÑ Processing ${coll} collection..."

            # Apply anonymization in-place
            mongosh "mongodb://127.0.0.1:27017/testdb" --eval "
              function anonymizeDoc(doc, fields) {
                fields.split(',').forEach(function(field) {
                  field = field.trim();
                  if (doc[field]) {
                    if (field === 'email') doc[field] = 'anon_' + Math.random().toString(36).substr(2,9) + '@test.com';
                    else if (field === 'phone') doc[field] = '555-XXX-XXXX';
                    else if (field === 'name') doc[field] = 'Anon User ' + Math.floor(Math.random()*1000);
                    else doc[field] = field + '_ANON_' + Math.floor(Math.random()*10000);
                  }
                });
                return doc;
              }

              const fields = '${ANONYMIZE_FIELDS}';
              db.${coll}.find().forEach(function(doc) {
                const anonDoc = anonymizeDoc(doc, fields);
                db.${coll}.replaceOne({_id: anonDoc._id}, anonDoc);
              });
            "

            # Dump anonymized data
            mongodump --db testdb --collection ${coll} \
              --archive=/tmp/${coll}-anon.archive.gz --gzip

            # Upload to S3
            aws s3 cp /tmp/${coll}-anon.archive.gz s3://${SYNC_BUCKET}/${DATETIME}/${coll}-anon.gz
            echo "‚úÖ ${coll} anonymized dump uploaded"
          done

          echo "üéâ Sync to S3 completed!"
        env:
        - name: MONGO_INITDB_ROOT_USERNAME
          value: "admin"
        volumeMounts:
        - name: mongo-data
          mountPath: /data/db
        - name: config
          mountPath: /etc/config
        resources:
          requests:
            cpu: "500m"
            memory: "1Gi"
          limits:
            cpu: "1000m"
            memory: "2Gi"
      volumes:
      - name: mongo-data
        persistentVolumeClaim:
          claimName: sync-pvc
      - name: config
        configMap:
          name: sync-config
